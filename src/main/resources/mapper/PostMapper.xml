<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.workingmoney.repository.post.PostMapper">

  <insert id="insert" parameterType="org.example.workingmoney.repository.post.PostEntity"
    useGeneratedKeys="true" keyProperty="id" keyColumn="id">
    insert into post (user_id, category_code, title, content, like_count, created_at, updated_at)
    values (#{userId}, #{categoryCode}, #{title}, #{content}, #{likeCount}, now(), now())
  </insert>

  <update id="update" parameterType="org.example.workingmoney.repository.post.PostEntity">
    update post
    set category_code = #{categoryCode},
        title = #{title},
        content = #{content},
        updated_at = now()
    where id = #{id}
  </update>

  <delete id="deleteById">
    delete from post
    where id = #{id}
  </delete>

  <select id="findById" resultType="org.example.workingmoney.repository.post.PostEntity">
    select p.id, p.user_id, p.category_code, p.title, p.content,
           coalesce(pl.like_count, 0) as like_count,
           p.created_at, p.updated_at
    from post p
    left join (
      select post_id, count(*) as like_count
      from post_like
      group by post_id
    ) pl on pl.post_id = p.id
    where p.id = #{id}
  </select>

  <select id="findPosts" resultType="org.example.workingmoney.repository.post.PostEntity">
    select p.id, p.user_id, p.category_code, p.title, p.content,
           coalesce(pl.like_count, 0) as like_count,
           p.created_at, p.updated_at
    from post p
    left join (
      select post_id, count(*) as like_count
      from post_like
      group by post_id
    ) pl on pl.post_id = p.id
    <where>
      <if test="categoryCode != null">
        and p.category_code = #{categoryCode}
      </if>
      <if test="cursor != null">
        and p.id &lt; #{cursor}
      </if>
    </where>
    order by p.id desc
    limit #{size}
  </select>

</mapper>


